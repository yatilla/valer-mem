<!DOCTYPE html>

<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, viewport-fit=cover">
<title>Valeron Mehmet</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
:root {
  --bg: #f2f2f7; --card: #ffffff; --border: #e5e5ea;
  --text: #000000; --text2: #6c6c70; --text3: #aeaeb2;
  --accent: #007aff; --accent-bg: rgba(0,122,255,0.1);
  --green: #34c759; --red: #ff3b30; --orange: #ff9500;
  --purple: #af52de; --nav-h: 83px; --top-h: 56px;
}
html,body { height:100%; overflow:hidden; font-family:'Inter',-apple-system,sans-serif; background:var(--bg); color:var(--text); }
.shell { display:flex; flex-direction:column; height:100vh; height:100dvh; max-width:480px; margin:0 auto; background:var(--bg); overflow:hidden; }

/* TOP BAR */
.topbar { height:var(--top-h); background:rgba(255,255,255,0.92); backdrop-filter:saturate(180%) blur(20px); border-bottom:0.5px solid var(--border); display:flex; align-items:center; justify-content:space-between; padding:0 18px; flex-shrink:0; z-index:50; }
.topbar-brand .topbar-title { font-size:17px; font-weight:700; letter-spacing:-0.3px; }
.topbar-brand .topbar-sub { font-size:11px; color:var(--text2); font-weight:500; }
.topbar-right { display:flex; align-items:center; gap:8px; }
.pill { display:flex; align-items:center; gap:5px; padding:5px 11px; border-radius:20px; font-size:12px; font-weight:600; cursor:pointer; }
.pill:active { opacity:.7; }
.pill-ok { background:rgba(52,199,89,.12); color:var(--green); }
.pill-warn { background:rgba(255,149,0,.12); color:var(--orange); }
.pill-crit { background:rgba(255,59,48,.12); color:var(--red); animation:pp 2s infinite; }
.pill-default { background:var(--bg); color:var(--text2); border:0.5px solid var(--border); }
@keyframes pp { 0%,100%{box-shadow:0 0 0 0 rgba(255,59,48,0);} 50%{box-shadow:0 0 0 3px rgba(255,59,48,.15);} }

/* SYNC indicator */
.sync-dot { width:8px; height:8px; border-radius:50%; background:var(--text3); flex-shrink:0; transition:background .3s; }
.sync-dot.live { background:var(--green); box-shadow:0 0 0 2px rgba(52,199,89,.25); }
.sync-dot.err { background:var(--red); }

/* CONTENT */
.content { flex:1; overflow:hidden; position:relative; }
.page { position:absolute; inset:0; overflow-y:auto; -webkit-overflow-scrolling:touch; opacity:0; pointer-events:none; transition:opacity .2s; padding-bottom:calc(100px + env(safe-area-inset-bottom)); scrollbar-width:none; }
.page::-webkit-scrollbar { display:none; }
.page.active { opacity:1; pointer-events:all; }

/* CALENDAR */
.cal-month-row { display:flex; align-items:center; justify-content:space-between; padding:14px 18px 10px; }
.cal-month-label { font-size:17px; font-weight:700; letter-spacing:-0.3px; }
.cal-nav-btns { display:flex; gap:8px; }
.nav-btn { width:30px; height:30px; border-radius:50%; background:var(--card); border:0.5px solid var(--border); display:flex; align-items:center; justify-content:center; font-size:15px; cursor:pointer; color:var(--accent); font-weight:700; }
.nav-btn:active { background:var(--bg); }
.filter-scroll { display:flex; gap:7px; padding:0 18px 12px; overflow-x:auto; -webkit-overflow-scrolling:touch; scrollbar-width:none; }
.filter-scroll::-webkit-scrollbar { display:none; }
.fc { display:flex; align-items:center; gap:5px; padding:6px 12px; border-radius:20px; font-size:12px; font-weight:600; cursor:pointer; white-space:nowrap; border:0.5px solid var(--border); background:var(--card); color:var(--text2); flex-shrink:0; }
.fc.active { background:var(--accent); border-color:var(--accent); color:#fff; }
.dow-row { display:grid; grid-template-columns:repeat(7,1fr); padding:0 10px; margin-bottom:4px; }
.dow { text-align:center; font-size:10px; font-weight:600; color:var(--text3); padding:3px 0; }
.cal-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:3px; padding:0 10px; }
.dc { aspect-ratio:1; border-radius:10px; background:var(--card); display:flex; flex-direction:column; align-items:center; justify-content:flex-start; padding:4px 2px 2px; cursor:pointer; position:relative; overflow:hidden; border:0.5px solid var(--border); transition:transform .1s; }
.dc:active { transform:scale(.94); }
.dc.om { opacity:.25; pointer-events:none; }
.dc.today { border-color:var(--accent); border-width:1.5px; }
.dc.today .dn { color:var(--accent); }
.dc.locked { border-color:var(--orange); border-width:1.5px; }
.dc.hd { background:#fff; }
.dc-bar { position:absolute; top:0; left:0; right:0; height:2.5px; border-radius:10px 10px 0 0; }
.dn { font-size:11px; font-weight:700; line-height:1; margin-bottom:3px; color:var(--text); }
.da { display:flex; flex-wrap:wrap; gap:1px; justify-content:center; }
.da-i { font-size:8px; line-height:1; }
.ds { position:absolute; bottom:2px; right:2px; font-size:7px; font-weight:700; color:var(--text3); }
.ds.pos { color:var(--green); }
.dl { position:absolute; top:1px; right:1px; font-size:8px; }

/* SECTION */
.sec-hdr { padding:20px 18px 8px; }
.sec-hdr h2 { font-size:22px; font-weight:800; letter-spacing:-0.5px; }
.sec-hdr p { font-size:13px; color:var(--text2); margin-top:2px; }
.sec-label { padding:20px 18px 8px; font-size:13px; font-weight:700; color:var(--text2); text-transform:uppercase; letter-spacing:.5px; }

/* CARDS */
.card-list-wrap { margin:0 18px 12px; background:var(--card); border-radius:14px; overflow:hidden; border:0.5px solid var(--border); }
.card-item { background:var(--card); padding:14px 16px; display:flex; align-items:center; gap:12px; cursor:pointer; border-bottom:0.5px solid var(--border); }
.card-item:last-child { border-bottom:none; }
.card-item:active { background:var(--bg); }
.ci-left { display:flex; align-items:center; gap:12px; flex:1; min-width:0; }
.ci-icon { font-size:28px; flex-shrink:0; }
.ci-info { flex:1; min-width:0; }
.ci-title { font-size:15px; font-weight:700; letter-spacing:-0.2px; }
.ci-sub { font-size:12px; color:var(--text2); margin-top:1px; }
.ci-right { display:flex; flex-direction:column; align-items:flex-end; gap:4px; flex-shrink:0; }
.badge { display:inline-flex; align-items:center; padding:3px 8px; border-radius:20px; font-size:11px; font-weight:700; }
.badge-blue { background:var(--accent-bg); color:var(--accent); }
.badge-green { background:rgba(52,199,89,.12); color:var(--green); }
.badge-orange { background:rgba(255,149,0,.12); color:var(--orange); }
.badge-red { background:rgba(255,59,48,.1); color:var(--red); }
.badge-gray { background:var(--bg); color:var(--text2); }

/* BEST */
.best-card { margin:0 18px 10px; background:var(--card); border-radius:14px; overflow:hidden; border:0.5px solid var(--border); }
.best-card-top { height:3px; }
.bc-body { padding:14px 16px; }
.bc-rank { font-size:10px; font-weight:700; color:var(--text3); letter-spacing:1px; text-transform:uppercase; margin-bottom:4px; }
.bc-date { font-size:17px; font-weight:800; letter-spacing:-0.4px; margin-bottom:10px; }
.bc-pills { display:flex; flex-wrap:wrap; gap:5px; margin-bottom:10px; }
.bc-pill { display:flex; align-items:center; gap:3px; padding:4px 9px; border-radius:20px; font-size:11px; font-weight:600; }
.bcp-y { background:rgba(52,199,89,.1); color:var(--green); }
.bcp-m { background:rgba(0,122,255,.1); color:var(--accent); }
.bcp-h { background:rgba(255,149,0,.1); color:var(--orange); }
.bcp-n { background:rgba(255,59,48,.07); color:var(--red); opacity:.7; }
.bc-footer { padding:10px 16px; border-top:0.5px solid var(--border); display:flex; gap:8px; }

/* KPI */
.kpi-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; padding:0 18px 12px; }
.kpi { background:var(--card); border-radius:14px; padding:14px; border:0.5px solid var(--border); }
.kpi-label { font-size:11px; font-weight:600; color:var(--text2); margin-bottom:6px; }
.kpi-val { font-size:28px; font-weight:800; letter-spacing:-1px; line-height:1; }
.kpi-sub { font-size:11px; color:var(--text3); margin-top:3px; }
.kv-blue{color:var(--accent);} .kv-green{color:var(--green);} .kv-red{color:var(--red);}
.chaos-wrap { margin:0 18px 12px; }
.chaos-card { background:var(--card); border-radius:14px; padding:16px; border:0.5px solid var(--border); }
.chaos-header { display:flex; align-items:flex-end; justify-content:space-between; margin-bottom:10px; }
.chaos-val { font-size:36px; font-weight:800; letter-spacing:-1.5px; line-height:1; }
.chaos-bar { height:6px; background:var(--bg); border-radius:3px; overflow:hidden; }
.chaos-fill { height:100%; background:linear-gradient(90deg,var(--green),var(--orange),var(--red)); border-radius:3px; transition:width .6s; }

/* LOCKED */
.locked-card { margin:0 18px 10px; background:var(--card); border-radius:14px; overflow:hidden; border:0.5px solid rgba(255,149,0,.35); }
.locked-banner { background:rgba(255,149,0,.07); padding:14px 16px; display:flex; align-items:center; justify-content:space-between; border-bottom:0.5px solid rgba(255,149,0,.15); }
.locked-date-str { font-size:15px; font-weight:800; letter-spacing:-0.3px; }
.locked-time { font-size:12px; font-weight:700; color:var(--orange); background:rgba(255,149,0,.12); padding:4px 10px; border-radius:20px; }
.locked-body { padding:14px 16px; }
.locked-sec { font-size:10px; font-weight:700; color:var(--text3); letter-spacing:1px; text-transform:uppercase; margin-bottom:7px; }
.locked-pills { display:flex; flex-wrap:wrap; gap:5px; margin-bottom:12px; }
.wa-box { background:var(--bg); border-radius:10px; padding:10px 12px; font-size:11px; color:var(--text2); white-space:pre-wrap; line-height:1.6; font-family:monospace; margin-bottom:10px; }
.locked-quote { text-align:center; font-size:13px; color:var(--text3); font-style:italic; padding:4px 0 8px; }
.locked-footer { padding:10px 16px; border-top:0.5px solid var(--border); display:flex; gap:7px; flex-wrap:wrap; }

/* LEAGUE */
.league-item { display:flex; align-items:center; gap:12px; padding:13px 16px; border-bottom:0.5px solid var(--border); }
.league-item:last-child { border-bottom:none; }
.li-rank { font-size:15px; font-weight:800; width:28px; text-align:center; flex-shrink:0; color:var(--text3); }
.li-rank.g{color:#FFD700;} .li-rank.s{color:#C0C0C0;} .li-rank.b{color:#CD7F32;}
.li-emoji { font-size:30px; flex-shrink:0; }
.li-info { flex:1; min-width:0; }
.li-name { font-size:15px; font-weight:700; }
.li-badges { font-size:13px; margin-top:2px; }
.li-right { display:flex; flex-direction:column; align-items:flex-end; gap:5px; }
.li-score { font-size:17px; font-weight:800; }
.li-bar { width:60px; height:3px; background:var(--bg); border-radius:3px; overflow:hidden; }
.li-bar-fill { height:100%; border-radius:3px; background:linear-gradient(90deg,var(--accent),var(--purple)); }

/* BOTTOM NAV */
.bottom-nav { height:calc(var(--nav-h) + env(safe-area-inset-bottom)); background:rgba(255,255,255,.92); backdrop-filter:saturate(180%) blur(20px); border-top:0.5px solid var(--border); display:flex; align-items:flex-start; padding-top:8px; padding-bottom:env(safe-area-inset-bottom); flex-shrink:0; z-index:50; }
.bn-item { flex:1; display:flex; flex-direction:column; align-items:center; gap:3px; cursor:pointer; padding:4px 0; transition:opacity .1s; position:relative; }
.bn-item:active { opacity:.6; }
.bn-icon { font-size:24px; line-height:1; transition:transform .15s; }
.bn-item.active .bn-icon { transform:scale(1.1); }
.bn-label { font-size:10px; font-weight:600; color:var(--text3); }
.bn-item.active .bn-label { color:var(--accent); }
.bn-dot { position:absolute; top:2px; right:calc(50% - 16px); width:8px; height:8px; background:var(--red); border-radius:50%; border:1.5px solid #fff; display:none; }
.bn-dot.show { display:block; }

/* MODAL */
.modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,.4); z-index:200; display:flex; align-items:flex-end; opacity:0; pointer-events:none; transition:opacity .25s; }
.modal-overlay.open { opacity:1; pointer-events:all; }
.modal-sheet { width:100%; max-width:480px; margin:0 auto; background:var(--card); border-radius:20px 20px 0 0; padding:0 0 40px; transform:translateY(100%); transition:transform .3s cubic-bezier(.32,.72,0,1); max-height:90vh; overflow-y:auto; }
.modal-overlay.open .modal-sheet { transform:translateY(0); }
.modal-handle { width:36px; height:4px; background:var(--text3); border-radius:2px; margin:12px auto 0; opacity:.4; }
.modal-hdr { padding:16px 20px 12px; border-bottom:0.5px solid var(--border); }
.modal-title { font-size:18px; font-weight:800; letter-spacing:-0.4px; }
.modal-sub { font-size:13px; color:var(--text2); margin-top:2px; }
.person-select-row { padding:14px 20px 4px; }
.ps-label { font-size:11px; font-weight:700; color:var(--text2); text-transform:uppercase; letter-spacing:.5px; margin-bottom:8px; display:block; }
.ps-scroll { display:flex; gap:7px; overflow-x:auto; padding-bottom:4px; scrollbar-width:none; }
.ps-scroll::-webkit-scrollbar { display:none; }
.ps-chip { display:flex; align-items:center; gap:5px; padding:7px 13px; border-radius:20px; font-size:12px; font-weight:600; cursor:pointer; white-space:nowrap; border:1.5px solid var(--border); background:var(--bg); color:var(--text2); flex-shrink:0; }
.ps-chip.active { border-color:var(--accent); background:var(--accent); color:#fff; }
.status-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; padding:14px 20px; }
.st-tile { background:var(--bg); border:1.5px solid var(--border); border-radius:14px; padding:14px 10px; text-align:center; cursor:pointer; transition:all .15s; }
.st-tile:active { transform:scale(.95); }
.st-icon { font-size:26px; margin-bottom:5px; }
.st-label { font-size:12px; font-weight:700; color:var(--text); }
.st-pts { font-size:10px; color:var(--text3); margin-top:2px; }
.st-tile.sel-y{border-color:var(--green);background:rgba(52,199,89,.08);}
.st-tile.sel-m{border-color:var(--accent);background:var(--accent-bg);}
.st-tile.sel-h{border-color:var(--orange);background:rgba(255,149,0,.08);}
.st-tile.sel-n{border-color:var(--red);background:rgba(255,59,48,.06);}
.modal-actions { padding:0 20px; display:flex; gap:10px; }

/* BUTTONS */
.btn { display:inline-flex; align-items:center; justify-content:center; gap:5px; padding:10px 16px; border-radius:12px; font-size:14px; font-weight:600; cursor:pointer; border:none; font-family:'Inter',sans-serif; }
.btn:active { opacity:.7; }
.btn-primary { background:var(--accent); color:#fff; flex:1; }
.btn-secondary { background:var(--bg); color:var(--text2); }
.btn-sm { padding:7px 12px; font-size:12px; border-radius:10px; background:var(--bg); color:var(--text2); border:none; cursor:pointer; font-family:'Inter',sans-serif; font-weight:600; }
.btn-sm:active { opacity:.7; }
.btn-sm-primary { background:var(--accent); color:#fff; }
.btn-sm-orange { background:rgba(255,149,0,.12); color:var(--orange); }
.btn-sm-green { background:rgba(52,199,89,.12); color:var(--green); }

/* EMPTY */
.empty { text-align:center; padding:48px 24px; color:var(--text3); }
.empty-icon { font-size:52px; margin-bottom:12px; }
.empty h3 { font-size:17px; font-weight:700; color:var(--text2); margin-bottom:5px; }
.empty p { font-size:14px; line-height:1.5; }

/* TOAST */
.toast-wrap { position:fixed; top:70px; left:50%; transform:translateX(-50%); z-index:300; display:flex; flex-direction:column; gap:6px; align-items:center; pointer-events:none; }
.toast { background:rgba(0,0,0,.82); color:#fff; padding:10px 18px; border-radius:20px; font-size:13px; font-weight:600; white-space:nowrap; animation:tin .2s ease; }
@keyframes tin { from{opacity:0;transform:translateY(-8px) scale(.95);}to{opacity:1;transform:none;} }

/* LOADING OVERLAY */
.loading-screen { position:fixed; inset:0; background:var(--bg); display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:500; gap:16px; transition:opacity .4s; }
.loading-screen.hidden { opacity:0; pointer-events:none; }
.loading-spinner { width:40px; height:40px; border:3px solid var(--border); border-top-color:var(--accent); border-radius:50%; animation:spin .8s linear infinite; }
@keyframes spin { to{transform:rotate(360deg);} }
.loading-text { font-size:15px; font-weight:600; color:var(--text2); }
</style>

</head>
<body>

<!-- LOADING -->

<div class="loading-screen" id="loadingScreen">
  <div style="font-size:40px">‚öî</div>
  <div class="loading-spinner"></div>
  <div class="loading-text">Baƒülanƒ±yor...</div>
</div>

<div class="shell">

  <!-- TOP BAR -->

  <div class="topbar">
    <div class="topbar-brand">
      <div class="topbar-title">‚öî Valeron Mehmet</div>
      <div class="topbar-sub">Arkada≈ülƒ±k Ligi</div>
    </div>
    <div class="topbar-right">
      <div class="sync-dot" id="syncDot" title="Baƒülantƒ± durumu"></div>
      <div id="meterPill" class="pill pill-default" onclick="setLastMeeting()">
        <span id="mIco">üìÖ</span><span id="mTxt">‚Äî</span>
      </div>
    </div>
  </div>

  <!-- PAGES -->

  <div class="content">

<!-- CALENDAR -->
<div class="page active" id="pCalendar">
  <div class="cal-month-row">
    <div class="cal-month-label" id="calMo">‚Äî</div>
    <div class="cal-nav-btns">
      <div class="nav-btn" onclick="chMo(-1)">‚Äπ</div>
      <div class="nav-btn" onclick="chMo(1)">‚Ä∫</div>
    </div>
  </div>
  <div class="filter-scroll" id="filterRow"></div>
  <div class="dow-row">
    <div class="dow">Pzt</div><div class="dow">Sal</div><div class="dow">√áar</div>
    <div class="dow">Per</div><div class="dow">Cum</div><div class="dow">Cmt</div><div class="dow">Paz</div>
  </div>
  <div class="cal-grid" id="cGrid"></div>
  <div class="sec-label">Bu Ayki Durum</div>
  <div class="card-list-wrap" id="quickInfo"></div>
</div>

<!-- BEST -->
<div class="page" id="pBest">
  <div class="sec-hdr"><h2>En ƒ∞yi Tarihler</h2><p>Aƒüƒ±rlƒ±klƒ± puana g√∂re √∂neriler</p></div>
  <div id="bestList"></div>
</div>

<!-- LEAGUE -->
<div class="page" id="pLeague">
  <div class="sec-hdr"><h2>Lig Tablosu</h2><p>Kim ne kadar sosyal?</p></div>
  <div class="card-list-wrap" id="leagueList"></div>
  <div class="sec-label">Rozetler</div>
  <div class="card-list-wrap" id="badgeList"></div>
</div>

<!-- STATS -->
<div class="page" id="pStats">
  <div class="sec-hdr"><h2>ƒ∞statistikler</h2><p>Sayƒ±lar yalan s√∂ylemez</p></div>
  <div class="kpi-grid" id="kpiGrid"></div>
  <div class="chaos-wrap"><div class="chaos-card" id="chaosCard"></div></div>
  <div class="sec-label">Ki≈üi D√∂k√ºm√º</div>
  <div class="card-list-wrap" id="personBreakdown"></div>
</div>

<!-- LOCKED + SETTINGS -->
<div class="page" id="pLocked">
  <div class="sec-hdr"><h2>Kilitlenen</h2><p>Takvim konu≈ütu. Ka√ßƒ±≈ü yok.</p></div>
  <div id="lockedList"></div>
  <div class="sec-label">Ayarlar</div>
  <div class="card-list-wrap">
    <div class="card-item" onclick="setLastMeeting()">
      <div class="ci-left"><div class="ci-icon">üìÖ</div><div class="ci-info"><div class="ci-title">Son Bulu≈ümayƒ± G√ºncelle</div><div class="ci-sub" id="lastMeetingLabel">Tarih girilmedi</div></div></div>
    </div>
    <div class="card-item" onclick="resetData()">
      <div class="ci-left"><div class="ci-icon">üóë</div><div class="ci-info"><div class="ci-title" style="color:var(--red)">T√ºm Verileri Sƒ±fƒ±rla</div><div class="ci-sub">Herkesten silinir</div></div></div>
    </div>
  </div>
</div>

  </div>

  <!-- BOTTOM NAV -->

  <div class="bottom-nav">
    <div class="bn-item active" onclick="showPage('Calendar',this)">
      <div class="bn-icon">üóì</div><div class="bn-label">Takvim</div>
    </div>
    <div class="bn-item" onclick="showPage('Best',this)">
      <div class="bn-icon">‚≠ê</div><div class="bn-label">En ƒ∞yi</div>
    </div>
    <div class="bn-item" onclick="showPage('League',this)">
      <div class="bn-icon">üèÜ</div><div class="bn-label">Lig</div>
    </div>
    <div class="bn-item" onclick="showPage('Stats',this)">
      <div class="bn-icon">üìä</div><div class="bn-label">ƒ∞statistik</div>
    </div>
    <div class="bn-item" onclick="showPage('Locked',this)">
      <div class="bn-icon">üîí</div><div class="bn-label">Kilitli</div>
      <div class="bn-dot" id="lockDot"></div>
    </div>
  </div>
</div>

<!-- MODAL -->

<div class="modal-overlay" id="modalOverlay" onclick="maybeClose(event)">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-hdr">
      <div class="modal-title" id="modalTitle">M√ºsaitlik Gir</div>
      <div class="modal-sub" id="modalSub"></div>
    </div>
    <div class="person-select-row">
      <span class="ps-label">Ki≈üi se√ß</span>
      <div class="ps-scroll" id="personChips"></div>
    </div>
    <div class="status-grid">
      <div class="st-tile" id="st-yes" onclick="setSt('yes')"><div class="st-icon">‚úÖ</div><div class="st-label">Kesin</div><div class="st-pts">+3 puan</div></div>
      <div class="st-tile" id="st-maybe" onclick="setSt('maybe')"><div class="st-icon">ü§î</div><div class="st-label">B√ºy√ºk ƒ∞htimalle</div><div class="st-pts">+2 puan</div></div>
      <div class="st-tile" id="st-hard" onclick="setSt('hard')"><div class="st-icon">üü°</div><div class="st-label">Zorlarƒ±m</div><div class="st-pts">+1 puan</div></div>
      <div class="st-tile" id="st-no" onclick="setSt('no')"><div class="st-icon">‚ùå</div><div class="st-label">M√ºsait Deƒüilim</div><div class="st-pts">‚àí2 puan</div></div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="clearSt()">Temizle</button>
      <button class="btn btn-primary" onclick="closeModal()">Tamam</button>
    </div>
  </div>
</div>

<div class="toast-wrap" id="tw"></div>

<!-- FIREBASE -->

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, onValue, set, get } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBrpwLW_Kn_crX5rqueYymaACT2_ANLRmA",
  authDomain: "duvar-8a77d.firebaseapp.com",
  databaseURL: "https://duvar-8a77d-default-rtdb.firebaseio.com",
  projectId: "duvar-8a77d",
  storageBucket: "duvar-8a77d.firebasestorage.app",
  messagingSenderId: "499059696985",
  appId: "1:499059696985:web:431799e27550b836efd848"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const dbRef = ref(db, 'valeron-mehmet');

// ‚îÄ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ‚îÄ
const P = [
  {id:'volkan',  name:'Volkan',       e:'ü¶ä'},
  {id:'melisa',  name:'Melisa',       e:'üåô'},
  {id:'sude',    name:'Sude',         e:'üêû'},
  {id:'yagmury', name:'Y. Yƒ±lmaz',   e:'üêØ'},
  {id:'yagmura', name:'Y. Atilla',   e:'ü¶Å'},
  {id:'emre',    name:'Emre',         e:'üêª‚Äç‚ùÑÔ∏è'},
  {id:'alper',   name:'Alper',        e:'üêª'},
];
const SS = {yes:3, maybe:2, hard:1, no:-2};
const SL = {yes:'Kesin', maybe:'B√ºy√ºk ƒ∞htimalle', hard:'Zorlarƒ±m', no:'M√ºsait Deƒüil'};
const SC = {yes:'var(--green)', maybe:'var(--accent)', hard:'var(--orange)', no:'var(--red)'};
const MO = ['Ocak','≈ûubat','Mart','Nisan','Mayƒ±s','Haziran','Temmuz','Aƒüustos','Eyl√ºl','Ekim','Kasƒ±m','Aralƒ±k'];
const DY = ['Pazar','Pazartesi','Salƒ±','√áar≈üamba','Per≈üembe','Cuma','Cumartesi'];

let D = {availability:{}, lockedDates:[], lastMeeting:null};
let vDate = new Date(), aF = 'all', selKey = null, selPid = P[0].id;

function dk(y,m,d){return `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;}
function pdk(k){const[y,m,d]=k.split('-').map(Number);return new Date(y,m-1,d);}

// ‚îÄ‚îÄ‚îÄ FIREBASE SYNC ‚îÄ‚îÄ‚îÄ
function saveToFirebase() {
  set(dbRef, D).catch(e => { console.error(e); toast('‚ö† Kayƒ±t hatasƒ±'); });
}

// Listen for real-time changes
onValue(dbRef, (snapshot) => {
  const data = snapshot.val();
  if (data) {
    D = { availability:{}, lockedDates:[], lastMeeting:null, ...data };
    // Ensure arrays
    if (!Array.isArray(D.lockedDates)) D.lockedDates = Object.values(D.lockedDates || {});
  }
  // Hide loading screen
  const ls = document.getElementById('loadingScreen');
  ls.classList.add('hidden');
  setTimeout(() => ls.style.display='none', 400);

  document.getElementById('syncDot').className = 'sync-dot live';
  renderAll();
}, (error) => {
  console.error(error);
  document.getElementById('syncDot').className = 'sync-dot err';
  document.getElementById('loadingScreen').classList.add('hidden');
  toast('‚ö† Baƒülantƒ± hatasƒ±');
});

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ
buildFilterRow();
buildPersonChips();

function renderAll() {
  renderCal();
  renderMeter();
  const active = document.querySelector('.page.active')?.id;
  if(active==='pBest') renderBest();
  if(active==='pLeague') renderLeague();
  if(active==='pStats') renderStats();
  if(active==='pLocked') renderLocked();
  updLockDot();
  updLastMeetingLabel();
}

// ‚îÄ‚îÄ‚îÄ NAV ‚îÄ‚îÄ‚îÄ
window.showPage = function(name, el) {
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById('p'+name).classList.add('active');
  document.querySelectorAll('.bn-item').forEach(b=>b.classList.remove('active'));
  el.classList.add('active');
  if(name==='Best') renderBest();
  if(name==='League') renderLeague();
  if(name==='Stats') renderStats();
  if(name==='Locked') renderLocked();
};

// ‚îÄ‚îÄ‚îÄ FILTER ‚îÄ‚îÄ‚îÄ
function buildFilterRow() {
  document.getElementById('filterRow').innerHTML =
    `<div class="fc active" onclick="setF('all',this)">üë• Herkes</div>` +
    P.map(p=>`<div class="fc" onclick="setF('${p.id}',this)">${p.e} ${p.name}</div>`).join('');
}
window.setF = function(v, el) {
  aF=v;
  document.querySelectorAll('.fc').forEach(c=>c.classList.remove('active'));
  el.classList.add('active');
  renderCal();
};

// ‚îÄ‚îÄ‚îÄ PERSON CHIPS ‚îÄ‚îÄ‚îÄ
function buildPersonChips() {
  document.getElementById('personChips').innerHTML = P.map((p,i)=>
    `<div class="ps-chip ${i===0?'active':''}" onclick="selectPerson('${p.id}',this)">${p.e} ${p.name}</div>`
  ).join('');
}
window.selectPerson = function(pid, el) {
  selPid=pid;
  document.querySelectorAll('.ps-chip').forEach(c=>c.classList.remove('active'));
  el.classList.add('active');
  refreshModal();
};

// ‚îÄ‚îÄ‚îÄ CALENDAR ‚îÄ‚îÄ‚îÄ
window.chMo = function(d) { vDate=new Date(vDate.getFullYear(),vDate.getMonth()+d,1); renderCal(); };

function renderCal() {
  const y=vDate.getFullYear(), m=vDate.getMonth();
  document.getElementById('calMo').textContent = `${MO[m]} ${y}`;
  const grid=document.getElementById('cGrid'); grid.innerHTML='';
  const fd=(new Date(y,m,1).getDay()+6)%7, ld=new Date(y,m+1,0).getDate();
  const today=new Date(), pl=new Date(y,m,0).getDate();
  for(let i=fd-1;i>=0;i--) grid.appendChild(mkCell(y,m-1,pl-i,true));
  for(let d=1;d<=ld;d++) {
    const c=mkCell(y,m,d,false);
    if(today.getFullYear()===y&&today.getMonth()===m&&today.getDate()===d) c.classList.add('today');
    grid.appendChild(c);
  }
  const rem=(7-(fd+ld)%7)%7;
  for(let d=1;d<=rem;d++) grid.appendChild(mkCell(y,m+1,d,true));
  renderQuickInfo(y,m);
}

function mkCell(y,m,d,om) {
  const key=dk(y,m,d), dd=D.availability[key]||{}, isL=D.lockedDates.some(l=>l.date===key);
  let sc=0; Object.values(dd).forEach(s=>sc+=SS[s]||0);
  const c=document.createElement('div');
  c.className='dc'+(om?' om':'')+(isL?' locked':'')+(Object.keys(dd).length?' hd':'');
  if(sc>0&&!om){
    const bar=document.createElement('div'); bar.className='dc-bar';
    const pct=Math.min(sc/(P.length*3),1);
    bar.style.background=`linear-gradient(90deg,var(--green) ${pct*100}%,var(--border) ${pct*100}%)`;
    c.appendChild(bar);
  }
  const dn=document.createElement('div'); dn.className='dn'; dn.textContent=d; c.appendChild(dn);
  const da=document.createElement('div'); da.className='da';
  if(aF==='all') {
    P.forEach(p=>{
      if(dd[p.id]){
        const a=document.createElement('div'); a.className='da-i';
        a.textContent=p.e; a.style.opacity=dd[p.id]==='no'?'0.3':'1'; da.appendChild(a);
      }
    });
  } else if(dd[aF]) {
    const dot=document.createElement('div');
    dot.style.cssText=`width:6px;height:6px;border-radius:50%;margin-top:2px;background:${SC[dd[aF]]||'#ccc'};`;
    da.appendChild(dot);
  }
  c.appendChild(da);
  if(sc!==0&&!om&&aF==='all'){
    const s=document.createElement('div'); s.className='ds'+(sc>0?' pos':''); s.textContent=(sc>0?'+':'')+sc; c.appendChild(s);
  }
  if(isL){const li=document.createElement('div');li.className='dl';li.textContent='üîí';c.appendChild(li);}
  c.onclick=()=>openModal(y,m,d,key);
  return c;
}

function renderQuickInfo(y,m) {
  const scored = Object.entries(D.availability)
    .filter(([k])=>{const dt=pdk(k);return dt.getFullYear()===y&&dt.getMonth()===m;})
    .map(([k,dd])=>{let s=0;Object.values(dd).forEach(st=>s+=SS[st]||0);return{k,s,dd};})
    .filter(x=>x.s>0).sort((a,b)=>b.s-a.s);
  const allSt=Object.values(D.availability).flatMap(d=>Object.values(d));
  const yc=allSt.filter(s=>s==='yes').length, nc=allSt.filter(s=>s==='no').length;
  const chaos=allSt.length?Math.round((nc/allSt.length)*100):0;
  let html='';
  if(scored.length){
    const b=scored[0], dt=pdk(b.k);
    const ycc=Object.values(b.dd).filter(s=>s==='yes').length;
    html+=`<div class="card-item"><div class="ci-left"><div class="ci-icon">‚≠ê</div><div class="ci-info"><div class="ci-title">En ƒ∞yi G√ºn</div><div class="ci-sub">${dt.getDate()} ${MO[dt.getMonth()]} ‚Äî ${ycc} kesin</div></div></div><div class="ci-right"><div class="badge badge-blue">+${b.s}p</div></div></div>`;
  }
  html+=`<div class="card-item"><div class="ci-left"><div class="ci-icon">üìä</div><div class="ci-info"><div class="ci-title">Kaos Seviyesi</div><div class="ci-sub">${chaos>50?'üî• Kritik!':chaos>25?'‚ö° Dikkat':'‚úÖ Sakin'}</div></div></div><div class="ci-right"><div class="badge ${chaos>50?'badge-red':chaos>25?'badge-orange':'badge-green'}">${chaos}%</div></div></div>`;
  html+=`<div class="card-item"><div class="ci-left"><div class="ci-icon">üë•</div><div class="ci-info"><div class="ci-title">Toplam ƒ∞≈üaret</div><div class="ci-sub">${yc} kesin, ${nc} bahane</div></div></div><div class="ci-right"><div class="badge badge-gray">${allSt.length}</div></div></div>`;
  document.getElementById('quickInfo').innerHTML=html;
}

// ‚îÄ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ‚îÄ
window.openModal = function(y,m,d,key) {
  selKey=key;
  document.getElementById('modalTitle').textContent=`${d} ${MO[m]} ${y}`;
  document.getElementById('modalSub').textContent=DY[pdk(key).getDay()];
  selPid=P[0].id;
  document.querySelectorAll('.ps-chip').forEach((c,i)=>c.classList.toggle('active',i===0));
  refreshModal();
  document.getElementById('modalOverlay').classList.add('open');
};
window.maybeClose = function(e){if(e.target===document.getElementById('modalOverlay'))closeModal();};
window.closeModal = function(){document.getElementById('modalOverlay').classList.remove('open');};

function refreshModal() {
  const cur=(D.availability[selKey]||{})[selPid];
  const map={yes:'sel-y',maybe:'sel-m',hard:'sel-h',no:'sel-n'};
  ['yes','maybe','hard','no'].forEach(s=>{
    const t=document.getElementById('st-'+s);
    t.className='st-tile'+(s===cur?' '+map[s]:'');
  });
}

window.setSt = function(s) {
  if(!D.availability[selKey]) D.availability[selKey]={};
  D.availability[selKey][selPid]=s;
  saveToFirebase();
  refreshModal();
  toast(`${P.find(p=>p.id===selPid).e} ${SL[s]}`);
};

window.clearSt = function() {
  if(D.availability[selKey]){
    delete D.availability[selKey][selPid];
    if(!Object.keys(D.availability[selKey]).length) delete D.availability[selKey];
  }
  saveToFirebase(); refreshModal(); closeModal();
};

// ‚îÄ‚îÄ‚îÄ BEST ‚îÄ‚îÄ‚îÄ
function renderBest() {
  const el=document.getElementById('bestList');
  const scored=Object.entries(D.availability).map(([key,dd])=>{
    let sc=0; const att={yes:[],maybe:[],hard:[],no:[]};
    Object.entries(dd).forEach(([pid,s])=>{sc+=SS[s]||0;if(att[s])att[s].push(pid);});
    return{key,sc,att};
  }).filter(x=>x.sc>0).sort((a,b)=>b.sc-a.sc).slice(0,5);
  if(!scored.length){el.innerHTML=`<div class="empty"><div class="empty-icon">üìÖ</div><h3>Veri yok</h3><p>Takvimde g√ºnlere tƒ±kla.</p></div>`;return;}
  const topColors=['linear-gradient(90deg,#007aff,#5ac8fa)','linear-gradient(90deg,#af52de,#007aff)','linear-gradient(90deg,#c0c0c0,#af52de)'];
  const ranks=['ü•á 1. √ñneri','ü•à 2. √ñneri','ü•â 3. √ñneri'];
  el.innerHTML=scored.map((d,i)=>{
    const dt=pdk(d.key);
    const ds=`${DY[dt.getDay()]}, ${dt.getDate()} ${MO[dt.getMonth()]} ${dt.getFullYear()}`;
    const isL=D.lockedDates.some(l=>l.date===d.key);
    return`<div class="best-card"><div class="best-card-top" style="background:${topColors[i]||'#ccc'}"></div><div class="bc-body"><div class="bc-rank">${ranks[i]||`#${i+1}`}</div><div class="bc-date">${ds}</div><div class="bc-pills">${d.att.yes.map(pid=>{const p=P.find(x=>x.id===pid);return`<div class="bc-pill bcp-y">${p.e} ${p.name}</div>`;}).join('')}${d.att.maybe.map(pid=>{const p=P.find(x=>x.id===pid);return`<div class="bc-pill bcp-m">${p.e} ${p.name}</div>`;}).join('')}${d.att.hard.map(pid=>{const p=P.find(x=>x.id===pid);return`<div class="bc-pill bcp-h">${p.e} ${p.name}</div>`;}).join('')}${d.att.no.map(pid=>{const p=P.find(x=>x.id===pid);return`<div class="bc-pill bcp-n">${p.e} ${p.name}</div>`;}).join('')}</div><div style="display:flex;gap:7px"><span class="badge badge-blue">+${d.sc}p</span>${d.att.yes.length?`<span class="badge badge-green">‚úÖ ${d.att.yes.length} kesin</span>`:''}</div></div><div class="bc-footer">${isL?'<button class="btn-sm" style="opacity:.5;cursor:default">üîí Kilitlendi</button>':`<button class="btn-sm btn-sm-orange" onclick="lockDate('${d.key}')">üîí Kilitle</button>`}<button class="btn-sm" onclick="goToCal('${d.key}')">üìÖ Takvimde G√∂r</button></div></div>`;
  }).join('');
}

window.lockDate = function(key) {
  const h=prompt('Bulu≈üma saati?','19:00')||'19:00';
  const att=Object.entries(D.availability[key]||{}).filter(([,s])=>s!=='no').map(([pid])=>pid);
  if(!Array.isArray(D.lockedDates)) D.lockedDates=[];
  D.lockedDates.push({date:key,hour:h,attendees:att});
  saveToFirebase(); toast('üîí Kilitlendi!');
  setTimeout(()=>showPage('Locked',document.querySelectorAll('.bn-item')[4]),500);
};

window.goToCal = function(key) {
  const dt=pdk(key); vDate=new Date(dt.getFullYear(),dt.getMonth(),1);
  showPage('Calendar',document.querySelectorAll('.bn-item')[0]); renderCal();
};

// ‚îÄ‚îÄ‚îÄ LEAGUE ‚îÄ‚îÄ‚îÄ
function renderLeague() {
  const sorted=[...P].map(p=>({...p,sc:pSc(p.id),m:pMet(p.id),b:calcBadges(p.id)})).sort((a,b)=>b.sc-a.sc);
  const max=Math.max(...sorted.map(s=>s.sc),1);
  const rc=[{cls:'g',sym:'ü•á'},{cls:'s',sym:'ü•à'},{cls:'b',sym:'ü•â'}];
  document.getElementById('leagueList').innerHTML=sorted.map((p,i)=>`
    <div class="league-item">
      <div class="li-rank ${rc[i]?.cls||''}">${rc[i]?.sym||i+1}</div>
      <div class="li-emoji">${p.e}</div>
      <div class="li-info">
        <div class="li-name">${p.name} <span style="font-size:13px">${p.b.map(b=>b.i).join('')}</span></div>
        <div class="li-badges" style="font-size:11px;color:var(--text3);margin-top:2px">‚úÖ${p.m.yes} ü§î${p.m.maybe} ‚ùå${p.m.no}</div>
      </div>
      <div class="li-right">
        <div class="li-score">${p.sc}</div>
        <div class="li-bar"><div class="li-bar-fill" style="width:${(p.sc/max)*100}%"></div></div>
      </div>
    </div>`).join('');
  const allB=[
    {i:'üî•',n:'Toplayƒ±cƒ±',o:sorted.reduce((a,b)=>a.m.yes>=b.m.yes?a:b).name,d:'En √ßok Kesin'},
    {i:'üèÉ',n:'Ka√ßak',o:sorted.reduce((a,b)=>a.m.no>=b.m.no?a:b).name,d:'En √ßok ‚ùå'},
    {i:'üß†',n:'Stratejist',o:sorted.reduce((a,b)=>a.m.maybe>=b.m.maybe?a:b).name,d:'En √ßok ü§î'},
    {i:'üèÜ',n:'MVP',o:sorted[0].name,d:'En y√ºksek puan'},
    {i:'üí§',n:'Sessiz',o:sorted[sorted.length-1].name,d:'En az aktif'},
  ];
  document.getElementById('badgeList').innerHTML=allB.map(b=>`
    <div class="card-item"><div class="ci-left"><div class="ci-icon">${b.i}</div><div class="ci-info"><div class="ci-title">${b.n}</div><div class="ci-sub">${b.o} ¬∑ ${b.d}</div></div></div></div>`).join('');
}

// ‚îÄ‚îÄ‚îÄ STATS ‚îÄ‚îÄ‚îÄ
function renderStats() {
  const allSt=Object.values(D.availability).flatMap(d=>Object.values(d));
  const tot=allSt.length,yc=allSt.filter(s=>s==='yes').length,nc=allSt.filter(s=>s==='no').length;
  const chaos=tot?Math.round((nc/tot)*100):0, part=tot?Math.round((yc/tot)*100):0;
  document.getElementById('kpiGrid').innerHTML=[
    {l:'Toplam ƒ∞≈üaret',v:tot,s:'kayƒ±t',c:'kv-blue'},
    {l:'Kesin Katƒ±lƒ±m',v:yc,s:`${part}% oran`,c:'kv-green'},
    {l:'Bahane Sayƒ±sƒ±',v:nc,s:'‚ùå i≈üaret',c:'kv-red'},
    {l:'Kilitlenen',v:D.lockedDates.length,s:'bulu≈üma',c:'kv-blue'},
  ].map(k=>`<div class="kpi"><div class="kpi-label">${k.l}</div><div class="kpi-val ${k.c}">${k.v}</div><div class="kpi-sub">${k.s}</div></div>`).join('');
  document.getElementById('chaosCard').innerHTML=`
    <div class="chaos-header">
      <div><div style="font-size:12px;font-weight:700;color:var(--text2);margin-bottom:4px">Kaos Seviyesi</div>
      <div class="chaos-val" style="color:${chaos>50?'var(--red)':chaos>25?'var(--orange)':'var(--green)'}">${chaos}%</div></div>
      <div style="text-align:right;font-size:13px;color:var(--text2);max-width:150px;line-height:1.4">${chaos>50?'üî• Grup daƒüƒ±lƒ±yor!':chaos>25?'‚ö° Dikkatli ol':'‚úÖ Her ≈üey yolunda'}</div>
    </div>
    <div class="chaos-bar"><div class="chaos-fill" style="width:${chaos}%"></div></div>`;
  const sorted=[...P].map(p=>({...p,sc:pSc(p.id),m:pMet(p.id)})).sort((a,b)=>b.sc-a.sc);
  document.getElementById('personBreakdown').innerHTML=sorted.map(p=>`
    <div class="card-item">
      <div class="ci-left"><div class="ci-icon">${p.e}</div>
        <div class="ci-info"><div class="ci-title">${p.name}</div>
          <div style="display:flex;gap:5px;margin-top:3px">
            <span class="badge badge-green" style="font-size:10px;padding:2px 6px">‚úÖ${p.m.yes}</span>
            <span class="badge badge-gray" style="font-size:10px;padding:2px 6px">ü§î${p.m.maybe}</span>
            <span class="badge badge-red" style="font-size:10px;padding:2px 6px">‚ùå${p.m.no}</span>
          </div>
        </div>
      </div>
      <div style="font-size:18px;font-weight:800">${p.sc}</div>
    </div>`).join('');
}

// ‚îÄ‚îÄ‚îÄ LOCKED ‚îÄ‚îÄ‚îÄ
function renderLocked() {
  const el=document.getElementById('lockedList');
  const locks = Array.isArray(D.lockedDates) ? D.lockedDates : Object.values(D.lockedDates||{});
  if(!locks.length){el.innerHTML=`<div class="empty"><div class="empty-icon">üîì</div><h3>Kilitlenen yok</h3><p>En ƒ∞yi Tarihler'den bir slot kilitle.</p></div>`;return;}
  el.innerHTML=locks.map((l,idx)=>{
    const dt=pdk(l.date);
    const ds=`${DY[dt.getDay()]}, ${dt.getDate()} ${MO[dt.getMonth()]} ${dt.getFullYear()}`;
    const att=l.attendees.map(pid=>P.find(p=>p.id===pid)).filter(Boolean);
    const miss=P.filter(p=>!l.attendees.includes(p.id));
    const wa=`‚öî VALERON MEHMET\nüìÖ ${ds} ‚è∞ ${l.hour}\n\n‚úÖ Katƒ±lanlar:\n${att.map(p=>`${p.e} ${p.name}`).join('\n')}${miss.length?`\n\n‚ùå Katƒ±lamayanlar:\n${miss.map(p=>`${p.e} ${p.name}`).join('\n')}`:''}`;
    const enc=encodeURIComponent(wa+'\n\nTakvim konu≈ütu. Ka√ßƒ±≈ü yok. üîí');
    return`<div class="locked-card">
      <div class="locked-banner">
        <div><div style="font-size:9px;font-weight:800;color:var(--orange);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:3px">‚úÖ KESƒ∞NLE≈ûTƒ∞</div><div class="locked-date-str">${ds}</div></div>
        <div class="locked-time">‚è∞ ${l.hour}</div>
      </div>
      <div class="locked-body">
        ${att.length?`<div class="locked-sec">Katƒ±lanlar</div><div class="locked-pills">${att.map(p=>`<div class="bc-pill bcp-y">${p.e} ${p.name}</div>`).join('')}</div>`:''}
        ${miss.length?`<div class="locked-sec">Katƒ±lamayanlar</div><div class="locked-pills">${miss.map(p=>`<div class="bc-pill bcp-n">${p.e} ${p.name}</div>`).join('')}</div>`:''}
        <div class="locked-sec">Mesaj</div>
        <div class="wa-box">${wa}</div>
        <div class="locked-quote">"Takvim konu≈ütu. Ka√ßƒ±≈ü yok."</div>
      </div>
      <div class="locked-footer">
        <button class="btn-sm btn-sm-primary" onclick="cpWA(${idx})">üìã Kopyala</button>
        <a href="https://wa.me/?text=${enc}" target="_blank"><button class="btn-sm" style="color:#25d366">üí¨ WA</button></a>
        <button class="btn-sm" onclick="dlICS(${idx})">üìÖ .ics</button>
        <button class="btn-sm" style="color:var(--red)" onclick="ulk(${idx})">üóë</button>
      </div>
    </div>`;
  }).join('');
}

window.cpWA = function(i) {
  const locks=Array.isArray(D.lockedDates)?D.lockedDates:Object.values(D.lockedDates||{});
  const l=locks[i]; const dt=pdk(l.date);
  const ds=`${DY[dt.getDay()]}, ${dt.getDate()} ${MO[dt.getMonth()]} ${dt.getFullYear()}`;
  const att=l.attendees.map(pid=>P.find(p=>p.id===pid)).filter(Boolean);
  const miss=P.filter(p=>!l.attendees.includes(p.id));
  const wa=`‚öî VALERON MEHMET\nüìÖ ${ds} ‚è∞ ${l.hour}\n\n‚úÖ Katƒ±lanlar:\n${att.map(p=>`${p.e} ${p.name}`).join('\n')}${miss.length?`\n\n‚ùå Katƒ±lamayanlar:\n${miss.map(p=>`${p.e} ${p.name}`).join('\n')}`:''}`;
  navigator.clipboard.writeText(wa+'\n\nTakvim konu≈ütu. Ka√ßƒ±≈ü yok. üîí').then(()=>toast('üìã Kopyalandƒ±!'));
};

window.dlICS = function(i) {
  const locks=Array.isArray(D.lockedDates)?D.lockedDates:Object.values(D.lockedDates||{});
  const l=locks[i]; const dt=pdk(l.date);
  const y=dt.getFullYear(),mo=String(dt.getMonth()+1).padStart(2,'0'),d=String(dt.getDate()).padStart(2,'0');
  const[hh,mm]=(l.hour||'19:00').split(':');
  const s=`${y}${mo}${d}T${String(hh).padStart(2,'0')}${String(mm||0).padStart(2,'0')}00`;
  const e=`${y}${mo}${d}T${String(Number(hh)+3).padStart(2,'0')}${String(mm||0).padStart(2,'0')}00`;
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([`BEGIN:VCALENDAR\nVERSION:2.0\nBEGIN:VEVENT\nSUMMARY:‚öî Valeron Mehmet Bulu≈ümasƒ±\nDTSTART:${s}\nDTEND:${e}\nEND:VEVENT\nEND:VCALENDAR`],{type:'text/calendar'}));
  a.download='bulusma.ics'; a.click(); toast('üìÖ ƒ∞ndirildi!');
};

window.ulk = function(i) {
  if(!confirm('Silinsin mi?')) return;
  const locks=Array.isArray(D.lockedDates)?[...D.lockedDates]:Object.values(D.lockedDates||{});
  locks.splice(i,1); D.lockedDates=locks;
  saveToFirebase(); toast('üóë Silindi!');
};

// ‚îÄ‚îÄ‚îÄ METER ‚îÄ‚îÄ‚îÄ
function renderMeter() {
  const pill=document.getElementById('meterPill'),txt=document.getElementById('mTxt'),ico=document.getElementById('mIco');
  if(!D.lastMeeting){pill.className='pill pill-default';txt.textContent='Tarih gir';ico.textContent='üìÖ';return;}
  const days=Math.floor((new Date()-new Date(D.lastMeeting))/86400000);
  if(days>45){pill.className='pill pill-crit';ico.textContent='‚ö†';txt.textContent=`${days}g`;}
  else if(days>30){pill.className='pill pill-warn';ico.textContent='‚ö°';txt.textContent=`${days}g`;}
  else{pill.className='pill pill-ok';ico.textContent='‚úÖ';txt.textContent=`${days}g`;}
}

window.setLastMeeting = function() {
  const d=prompt('Son bulu≈üma tarihi (YYYY-MM-DD):',new Date().toISOString().split('T')[0]);
  if(d&&/^\d{4}-\d{2}-\d{2}$/.test(d)){D.lastMeeting=d;saveToFirebase();toast('üìÖ G√ºncellendi!');}
};

function updLastMeetingLabel() {
  const el=document.getElementById('lastMeetingLabel');
  if(el) el.textContent=D.lastMeeting?`Son: ${D.lastMeeting}`:'Tarih girilmedi';
}

// ‚îÄ‚îÄ‚îÄ SCORING ‚îÄ‚îÄ‚îÄ
function pSc(pid){let s=0;Object.values(D.availability).forEach(d=>{if(d[pid])s+=SS[d[pid]]||0;});return s;}
function pMet(pid){const m={yes:0,no:0,maybe:0,hard:0};Object.values(D.availability).forEach(d=>{if(d[pid])m[d[pid]]++;});return m;}
function calcBadges(pid){
  const b=[],m=pMet(pid);
  const mY=Math.max(...P.map(p=>pMet(p.id).yes),0),mN=Math.max(...P.map(p=>pMet(p.id).no),0),mM=Math.max(...P.map(p=>pMet(p.id).maybe),0),mS=Math.max(...P.map(p=>pSc(p.id)),0);
  if(m.yes===mY&&mY>0)b.push({i:'üî•'});
  if(m.no===mN&&mN>0)b.push({i:'üèÉ'});
  if(m.maybe===mM&&mM>0)b.push({i:'üß†'});
  if(pSc(pid)===mS&&mS>0)b.push({i:'üèÜ'});
  if(m.yes&&m.maybe&&m.hard)b.push({i:'üïä'});
  return b;
}

// ‚îÄ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ‚îÄ
function updLockDot(){
  const n=(Array.isArray(D.lockedDates)?D.lockedDates:Object.values(D.lockedDates||{})).length;
  document.getElementById('lockDot').classList.toggle('show',n>0);
}

window.resetData = function() {
  if(!confirm('T√ºm veriler herkesten silinsin mi? Bu i≈ülem geri alƒ±namaz!')) return;
  D={availability:{},lockedDates:[],lastMeeting:null};
  saveToFirebase(); toast('üóë Sƒ±fƒ±rlandƒ±!');
};

function toast(msg){
  const w=document.getElementById('tw');const t=document.createElement('div');
  t.className='toast';t.textContent=msg;w.appendChild(t);
  setTimeout(()=>{t.style.opacity='0';t.style.transition='opacity .3s';},2000);
  setTimeout(()=>t.remove(),2400);
}

</script>

</body>
</html>
